# PAW Blockchain Secrets and ConfigMaps for Testing
# These are placeholder resources for smoke/monitoring tests
# IMPORTANT: Replace all placeholder values before production deployment
#
# Resources created:
# - Secret: paw-validator-keys (validator key storage)
# - Secret: paw-genesis (genesis secret reference)
# - Secret: paw-api-secrets (API authentication)
# - ConfigMap: paw-genesis (genesis file reference - alias)
# - ConfigMap: grafana-datasources (Prometheus datasource for Grafana)
# - ConfigMap: loki-config (Loki log aggregation configuration)
---
# =============================================================================
# SECRETS
# =============================================================================

# Secret: Validator Keys Template
# Used by StatefulSet for validator key storage
apiVersion: v1
kind: Secret
metadata:
  name: paw-validator-keys
  namespace: paw-blockchain
  labels:
    app: paw
    component: validator
    tier: security
  annotations:
    description: "Validator keys storage - REPLACE in production"
    security-level: "critical"
    production-note: "Use Vault, Sealed Secrets, or External Secrets Operator"
type: Opaque
stringData:
  # Placeholder keys - MUST be replaced before production
  # Generate real keys with: pawd init validator --chain-id paw-1
  priv_validator_key.json: |
    {
      "address": "PLACEHOLDER_VALIDATOR_ADDRESS",
      "pub_key": {
        "type": "tendermint/PubKeyEd25519",
        "value": "PLACEHOLDER_PUBKEY_BASE64"
      },
      "priv_key": {
        "type": "tendermint/PrivKeyEd25519",
        "value": "PLACEHOLDER_PRIVKEY_BASE64"
      }
    }
  node_key.json: |
    {
      "priv_key": {
        "type": "tendermint/PrivKeyEd25519",
        "value": "PLACEHOLDER_NODE_PRIVKEY_BASE64"
      }
    }

---
# Secret: Genesis Reference
# Used for genesis file signature verification
apiVersion: v1
kind: Secret
metadata:
  name: paw-genesis
  namespace: paw-blockchain
  labels:
    app: paw
    component: genesis
    tier: security
  annotations:
    description: "Genesis verification secrets - REPLACE in production"
    security-level: "critical"
type: Opaque
stringData:
  # GPG public key for genesis signature verification
  gpg-public-key: |
    -----BEGIN PGP PUBLIC KEY BLOCK-----

    PLACEHOLDER - Replace with actual GPG public key for genesis verification

    For production:
    1. Generate key: gpg --full-generate-key
    2. Export: gpg --armor --export your-email@domain.com
    3. Replace this placeholder with the exported key

    -----END PGP PUBLIC KEY BLOCK-----

  # Genesis file signature (detached)
  genesis-signature: "PLACEHOLDER_GENESIS_SIGNATURE"

---
# Secret: API Authentication
# Used by PAW API deployment for authentication
apiVersion: v1
kind: Secret
metadata:
  name: paw-api-secrets
  namespace: paw-blockchain
  labels:
    app: paw
    component: api
    tier: security
  annotations:
    description: "API authentication secrets - REPLACE in production"
    security-level: "high"
    production-note: "Generate secure random values before deployment"
type: Opaque
stringData:
  # JWT secret for API authentication
  # Generate with: openssl rand -base64 32
  JWT_SECRET: "PLACEHOLDER_REPLACE_WITH_SECURE_JWT_SECRET"

  # API key for service-to-service communication
  # Generate with: openssl rand -hex 32
  API_KEY: "PLACEHOLDER_REPLACE_WITH_SECURE_API_KEY"

  # Rate limiting secret for distributed rate limiting
  RATE_LIMIT_SECRET: "PLACEHOLDER_RATE_LIMIT_SECRET"

  # Webhook signing secret for callbacks
  WEBHOOK_SECRET: "PLACEHOLDER_WEBHOOK_SECRET"

---
# =============================================================================
# CONFIGMAPS
# =============================================================================

# ConfigMap: Genesis Reference (alias for tests expecting this name)
apiVersion: v1
kind: ConfigMap
metadata:
  name: paw-genesis
  namespace: paw-blockchain
  labels:
    app: paw
    component: genesis
  annotations:
    description: "Genesis file reference ConfigMap"
data:
  # Genesis download URL
  genesis_url: "https://raw.githubusercontent.com/paw-chain/paw/main/scripts/devnet/.state/genesis.json"

  # Expected chain ID
  chain_id: "paw-testnet-1"

  # Genesis time
  genesis_time: "2025-12-15T05:45:51.458863576Z"

  # SHA256 checksum for verification
  checksum: "0ad9a1be3badff543e777501c74d577249cfc0c13a0759e5b90c544a8688d106"

---
# ConfigMap: Grafana Datasources
# Configures Prometheus as the primary datasource for Grafana
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: paw-blockchain
  labels:
    app: grafana
    component: monitoring
  annotations:
    description: "Grafana datasource provisioning configuration"
data:
  datasources.yaml: |
    apiVersion: 1

    deleteDatasources:
      - name: Prometheus
        orgId: 1

    datasources:
      # Primary Prometheus datasource
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: false
        jsonData:
          timeInterval: "15s"
          httpMethod: POST
          exemplarTraceIdDestinations:
            - name: trace_id
              datasourceUid: jaeger
        uid: prometheus
        orgId: 1

      # Loki for logs
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        isDefault: false
        editable: false
        jsonData:
          maxLines: 1000
          derivedFields:
            - name: TraceID
              matcherRegex: "trace_id=(\\w+)"
              url: "$${__value.raw}"
              datasourceUid: jaeger
        uid: loki
        orgId: 1

      # Jaeger for tracing (optional)
      - name: Jaeger
        type: jaeger
        access: proxy
        url: http://jaeger:16686
        isDefault: false
        editable: false
        uid: jaeger
        orgId: 1

      # Alertmanager
      - name: Alertmanager
        type: alertmanager
        access: proxy
        url: http://alertmanager:9093
        isDefault: false
        editable: false
        jsonData:
          implementation: prometheus
        uid: alertmanager
        orgId: 1

---
# ConfigMap: Loki Configuration
# Basic Loki configuration for log aggregation
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: paw-blockchain
  labels:
    app: loki
    component: monitoring
  annotations:
    description: "Loki log aggregation configuration"
data:
  loki.yaml: |
    # Loki Configuration for PAW Blockchain
    auth_enabled: false

    server:
      http_listen_port: 3100
      grpc_listen_port: 9096
      log_level: info

    common:
      path_prefix: /loki
      storage:
        filesystem:
          chunks_directory: /loki/chunks
          rules_directory: /loki/rules
      replication_factor: 1
      ring:
        instance_addr: 127.0.0.1
        kvstore:
          store: inmemory

    ingester:
      wal:
        enabled: true
        dir: /loki/wal
      lifecycler:
        ring:
          kvstore:
            store: inmemory
          replication_factor: 1
      chunk_idle_period: 1h
      max_chunk_age: 1h
      chunk_target_size: 1048576
      chunk_retain_period: 30s

    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h

    storage_config:
      boltdb_shipper:
        active_index_directory: /loki/boltdb-shipper-active
        cache_location: /loki/boltdb-shipper-cache
        cache_ttl: 24h
        shared_store: filesystem
      filesystem:
        directory: /loki/chunks

    compactor:
      working_directory: /loki/boltdb-shipper-compactor
      shared_store: filesystem
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150

    limits_config:
      enforce_metric_name: false
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      max_cache_freshness_per_query: 10m
      split_queries_by_interval: 15m
      # Retention period - 7 days
      retention_period: 168h

    chunk_store_config:
      max_look_back_period: 0s

    table_manager:
      retention_deletes_enabled: true
      retention_period: 168h

    query_range:
      align_queries_with_step: true
      max_retries: 5
      cache_results: true
      results_cache:
        cache:
          embedded_cache:
            enabled: true
            max_size_mb: 100

    ruler:
      storage:
        type: local
        local:
          directory: /loki/rules
      rule_path: /loki/rules-temp
      alertmanager_url: http://alertmanager:9093
      ring:
        kvstore:
          store: inmemory
      enable_api: true

---
# ConfigMap: Grafana Dashboard Provisioning (if not already present)
# This ensures dashboard provisioning works with the existing dashboards ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: paw-blockchain
  labels:
    app: grafana
    component: monitoring
  annotations:
    description: "Grafana dashboard provisioning provider configuration"
data:
  dashboards.yaml: |
    apiVersion: 1

    providers:
      - name: 'PAW Blockchain Dashboards'
        orgId: 1
        folder: 'PAW'
        folderUid: 'paw-dashboards'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards
          foldersFromFilesStructure: true

      - name: 'Kubernetes Dashboards'
        orgId: 1
        folder: 'Kubernetes'
        folderUid: 'k8s-dashboards'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        options:
          path: /var/lib/grafana/dashboards/kubernetes

---
# ConfigMap: Prometheus Rules for Secrets/ConfigMaps monitoring
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-secrets-rules
  namespace: paw-blockchain
  labels:
    app: prometheus
    component: monitoring
  annotations:
    description: "Prometheus alert rules for secrets and config management"
data:
  secrets-rules.yml: |
    groups:
      - name: secrets.alerts
        interval: 1m
        rules:
          # Alert if secrets are accessed too frequently
          - alert: HighSecretAccessRate
            expr: rate(apiserver_request_total{resource="secrets",verb="get"}[5m]) > 100
            for: 5m
            labels:
              severity: warning
              team: security
            annotations:
              summary: "High secret access rate detected"
              description: "Secrets are being accessed at {{ $value | humanize }}/sec"

          # Alert if configmaps are modified frequently
          - alert: FrequentConfigMapChanges
            expr: increase(apiserver_request_total{resource="configmaps",verb=~"update|patch"}[1h]) > 50
            for: 5m
            labels:
              severity: info
              team: platform
            annotations:
              summary: "Frequent ConfigMap changes detected"
              description: "ConfigMaps have been modified {{ $value }} times in the last hour"
