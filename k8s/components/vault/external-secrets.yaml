---
# External Secrets Operator namespace
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
---
# Note: External Secrets Operator is typically installed via Helm
# helm repo add external-secrets https://charts.external-secrets.io
# helm install external-secrets external-secrets/external-secrets -n external-secrets

# ClusterSecretStore for Vault
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "http://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      auth:
        tokenSecretRef:
          name: vault-token
          namespace: external-secrets
          key: token
---
# Vault token secret (for dev mode)
apiVersion: v1
kind: Secret
metadata:
  name: vault-token
  namespace: external-secrets
type: Opaque
stringData:
  token: "paw-dev-token"
---
# ExternalSecret for validator keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: paw-validator-keys
  namespace: paw
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend
  target:
    name: paw-validator-keys
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: paw
          app.kubernetes.io/component: validator
  data:
    - secretKey: priv_validator_key.json
      remoteRef:
        key: secret/data/paw/validators
        property: priv_validator_key
    - secretKey: node_key.json
      remoteRef:
        key: secret/data/paw/validators
        property: node_key
---
# ExternalSecret for genesis
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: paw-genesis
  namespace: paw
spec:
  refreshInterval: 24h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend
  target:
    name: paw-genesis
    creationPolicy: Owner
  data:
    - secretKey: genesis.json
      remoteRef:
        key: secret/data/paw/genesis
        property: genesis_json
---
# ExternalSecret for API JWT
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: paw-api-secrets
  namespace: paw
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend
  target:
    name: paw-api-secrets
    creationPolicy: Owner
  data:
    - secretKey: jwt_secret
      remoteRef:
        key: secret/data/paw/api
        property: jwt_secret
