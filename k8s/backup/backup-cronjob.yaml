---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: paw-validator-backup
  namespace: paw-blockchain
  labels:
    app.kubernetes.io/name: paw
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: paw-network
spec:
  schedule: "0 2 * * *"  # Daily at 2am
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: paw
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: backup
              image: 100.91.253.108:5000/pawd:latest
              imagePullPolicy: Always
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -e
                  echo "=== PAW Validator Backup ==="
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  BACKUP_DIR="/backup"
                  BACKUP_FILE="paw-validator-backup-${TIMESTAMP}.tar.gz"

                  echo "Creating backup directory..."
                  mkdir -p ${BACKUP_DIR}

                  echo "Creating snapshot of validator data..."
                  cd /data

                  # Create tarball of data directory
                  tar -czf ${BACKUP_DIR}/${BACKUP_FILE} \
                    --exclude='*.log' \
                    --exclude='*.tmp' \
                    config/ data/ 2>/dev/null || true

                  # Verify backup was created
                  if [ -f "${BACKUP_DIR}/${BACKUP_FILE}" ]; then
                    SIZE=$(ls -lh ${BACKUP_DIR}/${BACKUP_FILE} | awk '{print $5}')
                    echo "Backup created successfully: ${BACKUP_FILE} (${SIZE})"
                  else
                    echo "ERROR: Backup file was not created"
                    exit 1
                  fi

                  # Clean up old backups (keep last 7 days)
                  echo "Cleaning up old backups..."
                  find ${BACKUP_DIR} -name "paw-validator-backup-*.tar.gz" -mtime +7 -delete 2>/dev/null || true

                  echo "Backup complete!"
              securityContext:
                runAsUser: 1000
                runAsGroup: 1000
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop: ["ALL"]
              resources:
                limits:
                  cpu: "500m"
                  memory: "512Mi"
                requests:
                  cpu: "100m"
                  memory: "256Mi"
              volumeMounts:
                - name: data
                  mountPath: /data
                  readOnly: true
                - name: backup
                  mountPath: /backup
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: data-paw-validator-0
            - name: backup
              persistentVolumeClaim:
                claimName: paw-backup-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: paw-backup-pvc
  namespace: paw-blockchain
  labels:
    app.kubernetes.io/name: paw
    app.kubernetes.io/component: backup
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 20Gi
