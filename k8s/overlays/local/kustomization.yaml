apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: paw-local

namespace: paw

resources:
  - ../../base
  - ../../validators
  - configmaps/paw-config.yaml

patches:
  # Reduce replicas for local testing
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: StatefulSet
      name: paw-validator

  # Use local storage class
  - patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/storageClassName
        value: local-path
    target:
      kind: StatefulSet
      name: paw-validator

  # Reduce storage for local
  - patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/resources/requests/storage
        value: 10Gi
    target:
      kind: StatefulSet
      name: paw-validator

  # Use local registry image
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: localhost:5050/pawd:latest
      - op: replace
        path: /spec/template/spec/initContainers/1/image
        value: localhost:5050/pawd:latest
    target:
      kind: StatefulSet
      name: paw-validator

  # Reduce resource requests for local dev
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "2"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "4Gi"
    target:
      kind: StatefulSet
      name: paw-validator

  # Disable PDB for single replica
  - patch: |-
      - op: replace
        path: /spec/minAvailable
        value: 0
    target:
      kind: PodDisruptionBudget
      name: paw-validator-pdb

labels:
  - includeSelectors: true
    pairs:
      environment: local
      app.kubernetes.io/instance: paw-local

commonAnnotations:
  deployed-by: kustomize
  environment: local
