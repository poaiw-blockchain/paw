SPECIFICATION Spec

\* Constants configuration
CONSTANTS
    VALIDATORS = {v1, v2, v3, v4, v5, v6, v7}
    MAX_PRICE = 10000
    MIN_PRICE = 100
    VOTE_THRESHOLD = 67      \* 67% voting power required
    MAD_THRESHOLD = 35       \* 3.5 (scaled by 10)
    IQR_MULTIPLIER = 15      \* 1.5 (scaled by 10)
    TWAP_WINDOW = 100
    MAX_BLOCKS = 50
    byzantine = {v6, v7}     \* Two Byzantine validators (f=2, n=7, f < n/3)

\* State constraints for bounded model checking
CONSTRAINT
    /\ blockHeight <= MAX_BLOCKS
    /\ Len(priceSubmissions) <= 10
    /\ Len(priceHistory) <= 20
    /\ Len(slashingRecords) <= 10
    /\ Len(operationLog) <= 40

\* Invariants to check (BFT SAFETY PROPERTIES)
INVARIANTS
    TypeOK
    BFTConstraintAlwaysHolds
    ValidityInvariant
    VoteThresholdEnforced
    DataFreshness
    NoPriceFromAllByzantine

\* Critical properties to verify
PROPERTIES
    Spec => []BFTConstraintAlwaysHolds
    Spec => []ValidityInvariant
    Spec => []VoteThresholdEnforced
    Spec => []NoPriceFromAllByzantine

\* Symmetry optimization (only for honest validators)
SYMMETRY
    Permutations({v1, v2, v3, v4, v5})

\* Check for deadlocks
CHECK_DEADLOCK TRUE

\* Temporal properties (commented out for initial safety check)
\* PROPERTIES
\*     EventuallyAggregated
\*     EventuallySlashed
\*     EventuallyHealed

\* View configuration for counterexamples
VIEW
    <<aggregatedPrice, blockHeight, Len(priceSubmissions)>>

\* Model checking configuration
\* Run with: tlc -config oracle_bft.cfg oracle_bft.tla
\* For exhaustive checking: tlc -workers auto -deadlock -config oracle_bft.cfg oracle_bft.tla

\* Byzantine validator testing scenarios
\* Scenario 1: Byzantine validators submit extreme prices
\* Scenario 2: Byzantine validators collude
\* Scenario 3: Network partition with Byzantine validators
\* All scenarios should be detected by outlier detection and slashing
