SPECIFICATION Spec

\* Constants configuration
CONSTANTS
    MAX_ESCROWS = 5
    MAX_AMOUNT = 10000
    TIMEOUT_BLOCKS = 100
    CHALLENGE_BLOCKS = 10
    REQUESTERS = {r1, r2}
    PROVIDERS = {p1, p2}

\* State constraints for bounded model checking
CONSTRAINT
    /\ blockHeight <= 200
    /\ totalLocked <= 50000
    /\ totalReleased <= 50000
    /\ totalRefunded <= 50000
    /\ Len(operationLog) <= 30

\* Invariants to check (CRITICAL SAFETY PROPERTIES)
INVARIANTS
    TypeOK
    NoDoubleSpend
    MutualExclusion
    NoDoubleRelease
    NoDoubleRefund
    ExactlyOneOutcome
    NonceUniqueness
    ValidStateTransitions
    ChallengePeriodIntegrity
    TimestampConsistency

\* Properties to verify
PROPERTIES
    Spec => []NoDoubleSpend
    Spec => []MutualExclusion
    Spec => []NoDoubleRelease
    Spec => []NoDoubleRefund
    Spec => []ExactlyOneOutcome

\* Symmetry optimization
SYMMETRY
    Permutations(REQUESTERS)
    Permutations(PROVIDERS)

\* Check for deadlocks
CHECK_DEADLOCK TRUE

\* Temporal properties (commented out for initial safety check)
\* PROPERTIES
\*     EventuallyFinalized
\*     ExpiredEventuallyRefunded

\* Model checking configuration
\* Run with: tlc -config escrow_safety.cfg escrow_safety.tla
\* For deeper checking: tlc -workers auto -config escrow_safety.cfg escrow_safety.tla
