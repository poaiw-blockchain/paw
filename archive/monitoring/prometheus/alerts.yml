# PAW Blockchain - Prometheus Alert Rules
# Define alerts for monitoring blockchain health

groups:
  - name: paw_blockchain_alerts
    interval: 30s
    rules:
      # Validator Health Alerts
      - alert: ValidatorDown
        expr: up{job="paw-validators"} == 0
        for: 2m
        labels:
          severity: critical
          component: validator
        annotations:
          summary: 'Validator {{ $labels.instance }} is down'
          description: 'Validator {{ $labels.instance }} has been down for more than 2 minutes.'

      - alert: ValidatorNotSigning
        expr: rate(cometbft_consensus_validator_last_signed_height[5m]) == 0
        for: 5m
        labels:
          severity: critical
          component: validator
        annotations:
          summary: 'Validator {{ $labels.instance }} is not signing blocks'
          description: 'Validator {{ $labels.instance }} has not signed any blocks in the last 5 minutes.'

      - alert: ValidatorMissedBlocks
        expr: increase(cometbft_consensus_validator_missed_blocks[10m]) > 10
        for: 5m
        labels:
          severity: warning
          component: validator
        annotations:
          summary: 'Validator {{ $labels.instance }} missing blocks'
          description: 'Validator {{ $labels.instance }} has missed {{ $value }} blocks in the last 10 minutes.'

      # Node Health Alerts
      - alert: NodeDown
        expr: up{job="paw-nodes"} == 0
        for: 5m
        labels:
          severity: warning
          component: node
        annotations:
          summary: 'Node {{ $labels.instance }} is down'
          description: 'Node {{ $labels.instance }} has been down for more than 5 minutes.'

      - alert: NodeNotSyncing
        expr: cometbft_consensus_latest_block_height - on(instance) cometbft_consensus_latest_block_height offset 1m < 10
        for: 5m
        labels:
          severity: warning
          component: node
        annotations:
          summary: 'Node {{ $labels.instance }} is not syncing'
          description: 'Node {{ $labels.instance }} has not advanced block height in the last minute.'

      # Chain Health Alerts
      - alert: ChainHalted
        expr: rate(cometbft_consensus_latest_block_height[5m]) == 0
        for: 2m
        labels:
          severity: critical
          component: chain
        annotations:
          summary: 'Blockchain appears to be halted'
          description: 'No new blocks have been produced in the last 2 minutes across all monitored nodes.'

      - alert: SlowBlockTime
        expr: rate(cometbft_consensus_block_interval_seconds[5m]) > 8
        for: 5m
        labels:
          severity: warning
          component: chain
        annotations:
          summary: 'Block time is slower than expected'
          description: 'Average block time is {{ $value }}s, which is higher than the expected 4s.'

      - alert: HighBlockInterval
        expr: (cometbft_consensus_latest_block_height - on(instance) cometbft_consensus_latest_block_height offset 1m) < 10
        for: 3m
        labels:
          severity: warning
          component: chain
        annotations:
          summary: 'Low block production rate'
          description: 'Only {{ $value }} blocks produced in the last minute on {{ $labels.instance }}.'

      # P2P Network Alerts
      - alert: LowPeerCount
        expr: cometbft_p2p_peers < 3
        for: 5m
        labels:
          severity: warning
          component: p2p
        annotations:
          summary: 'Low peer count on {{ $labels.instance }}'
          description: '{{ $labels.instance }} has only {{ $value }} peers. Minimum recommended is 5.'

      - alert: NoPeers
        expr: cometbft_p2p_peers == 0
        for: 2m
        labels:
          severity: critical
          component: p2p
        annotations:
          summary: 'No peers connected to {{ $labels.instance }}'
          description: '{{ $labels.instance }} has no peer connections. Node is isolated.'

      # Resource Alerts
      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes{pod=~"paw-.*"} / container_spec_memory_limit_bytes{pod=~"paw-.*"}) > 0.9
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: 'High memory usage on {{ $labels.pod }}'
          description: 'Memory usage is above 90% on {{ $labels.pod }}.'

      - alert: HighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{pod=~"paw-.*"}[5m]) > 0.9
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: 'High CPU usage on {{ $labels.pod }}'
          description: 'CPU usage is above 90% on {{ $labels.pod }}.'

      - alert: DiskSpaceRunningLow
        expr: (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) < 0.15
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: 'Disk space running low on {{ $labels.persistentvolumeclaim }}'
          description: 'Disk space is below 15% on {{ $labels.persistentvolumeclaim }}.'

      - alert: DiskSpaceCritical
        expr: (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) < 0.05
        for: 2m
        labels:
          severity: critical
          component: resources
        annotations:
          summary: 'Disk space critical on {{ $labels.persistentvolumeclaim }}'
          description: 'Disk space is below 5% on {{ $labels.persistentvolumeclaim }}. Immediate action required.'

      # Mempool Alerts
      - alert: HighMempoolSize
        expr: cometbft_mempool_size > 5000
        for: 10m
        labels:
          severity: warning
          component: mempool
        annotations:
          summary: 'High mempool size on {{ $labels.instance }}'
          description: 'Mempool has {{ $value }} transactions on {{ $labels.instance }}. Capacity is 5000.'

      - alert: MempoolFull
        expr: cometbft_mempool_size >= 5000
        for: 5m
        labels:
          severity: critical
          component: mempool
        annotations:
          summary: 'Mempool is full on {{ $labels.instance }}'
          description: 'Mempool is at capacity ({{ $value }} transactions) on {{ $labels.instance }}.'

      # Consensus Alerts
      - alert: ConsensusFailure
        expr: rate(cometbft_consensus_failure_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: consensus
        annotations:
          summary: 'Consensus failures detected on {{ $labels.instance }}'
          description: '{{ $value }} consensus failures per second on {{ $labels.instance }}.'

      - alert: HighProposalTimeout
        expr: rate(cometbft_consensus_timeout_propose_seconds_count[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: consensus
        annotations:
          summary: 'High proposal timeout rate on {{ $labels.instance }}'
          description: 'Proposal timeouts occurring at {{ $value }}/s on {{ $labels.instance }}.'

      # Application Alerts
      - alert: HighTxFailureRate
        expr: rate(cometbft_consensus_failed_txs_total[5m]) / rate(cometbft_consensus_total_txs_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: 'High transaction failure rate on {{ $labels.instance }}'
          description: '{{ $value | humanizePercentage }} of transactions are failing on {{ $labels.instance }}.'

  - name: kubernetes_alerts
    interval: 30s
    rules:
      # Kubernetes Pod Alerts
      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total{namespace="paw-blockchain"}[15m]) > 0
        for: 5m
        labels:
          severity: warning
          component: kubernetes
        annotations:
          summary: 'Pod {{ $labels.pod }} is crash looping'
          description: 'Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crash looping.'

      - alert: PodNotReady
        expr: kube_pod_status_phase{namespace="paw-blockchain", phase!="Running"} > 0
        for: 5m
        labels:
          severity: warning
          component: kubernetes
        annotations:
          summary: 'Pod {{ $labels.pod }} is not ready'
          description: 'Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been in {{ $labels.phase }} state for 5 minutes.'
