version: '3.8'

services:
  # PAW node with hot reload for development
  paw-node:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: paw-node-dev
    restart: unless-stopped
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Persist blockchain data
      - paw-data:/root/.paw
      # Cache Go modules
      - go-modules:/go/pkg/mod
    ports:
      # Tendermint RPC
      - '26657:26657'
      # REST API
      - '1317:1317'
      # gRPC
      - '9090:9090'
      # Prometheus metrics
      - '26660:26660'
      # P2P
      - '26656:26656'
    environment:
      - CHAIN_ID=paw-dev-1
      - MONIKER=dev-node
      - LOG_LEVEL=info
      - ENABLE_API=true
      - ENABLE_GRPC=true
      - ENABLE_SWAGGER=true
      - MINIMUM_GAS_PRICES=0.001upaw
    command: >
      sh -c "
        if [ ! -d /root/.paw/config ]; then
          echo 'Initializing node...';
          pawd init dev-node --chain-id paw-dev-1;
          echo 'Node initialized';
        fi;
        echo 'Starting node...';
        pawd start --api.enable --api.swagger --grpc.enable
      "
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:26657/health']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - paw-network

  # Additional validator node for testing multi-node setup
  paw-validator-2:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: paw-validator-2-dev
    restart: unless-stopped
    volumes:
      - .:/app
      - paw-validator2-data:/root/.paw
      - go-modules:/go/pkg/mod
    ports:
      - '26667:26657'
      - '1327:1317'
      - '9091:9090'
    environment:
      - CHAIN_ID=paw-dev-1
      - MONIKER=validator-2
      - LOG_LEVEL=info
      - ENABLE_API=true
      - ENABLE_GRPC=true
    command: >
      sh -c "
        if [ ! -d /root/.paw/config ]; then
          echo 'Initializing validator 2...';
          pawd init validator-2 --chain-id paw-dev-1;
        fi;
        pawd start --api.enable --grpc.enable
      "
    depends_on:
      - paw-node
    networks:
      - paw-network

  # PostgreSQL for indexing (optional)
  postgres:
    image: postgres:15-alpine
    container_name: paw-postgres-dev
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=paw_indexer
      - POSTGRES_USER=paw
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U paw']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - paw-network

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: paw-redis-dev
    restart: unless-stopped
    volumes:
      - redis-data:/data
    ports:
      - '6379:6379'
    command: redis-server --appendonly yes
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - paw-network

  # Prometheus for metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: paw-prometheus-dev
    restart: unless-stopped
    volumes:
      - ./infra/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - '9090:9090'
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - paw-network

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: paw-grafana-dev
    restart: unless-stopped
    volumes:
      - grafana-data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
    ports:
      - '3000:3000'
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-changeme}
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus
    networks:
      - paw-network

volumes:
  paw-data:
    driver: local
  paw-validator2-data:
    driver: local
  go-modules:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

networks:
  paw-network:
    driver: bridge
