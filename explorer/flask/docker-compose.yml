version: '3.8'

# PAW Flask Explorer - Docker Compose Configuration
# Production-ready deployment with nginx reverse proxy

services:
  # Flask application
  paw-flask:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: paw-flask
    restart: unless-stopped
    environment:
      # Flask configuration
      FLASK_APP: app.py
      FLASK_ENV: production
      FLASK_DEBUG: "false"
      FLASK_SECRET_KEY: ${FLASK_SECRET_KEY:-change-me-in-production}

      # Service endpoints
      INDEXER_API_URL: ${INDEXER_API_URL:-http://paw-indexer:8080}
      RPC_URL: ${RPC_URL:-http://paw-node:26657}
      GRPC_URL: ${GRPC_URL:-paw-node:9090}

      # Application settings
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-30}
      MAX_ITEMS_PER_PAGE: ${MAX_ITEMS_PER_PAGE:-100}
      DEFAULT_ITEMS_PER_PAGE: ${DEFAULT_ITEMS_PER_PAGE:-20}

      # Gunicorn settings
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-4}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-2}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-120}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

    volumes:
      # Mount logs directory
      - flask-logs:/app/logs
      # Mount templates and static (for development, remove in production)
      # - ./templates:/app/templates
      # - ./static:/app/static

    networks:
      - paw-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx reverse proxy
  paw-nginx:
    image: nginx:1.25-alpine
    container_name: paw-nginx
    restart: unless-stopped
    ports:
      # Explorer port (PAW range: 11000-11999)
      - "11080:11080"
    volumes:
      # Nginx configuration
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Static files (if serving from nginx)
      - ./static:/app/static:ro
      # Logs
      - nginx-logs:/var/log/nginx
      # Cache
      - nginx-cache:/var/cache/nginx

    networks:
      - paw-network

    depends_on:
      paw-flask:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:11080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  paw-network:
    name: paw-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  flask-logs:
    name: paw-flask-logs
  nginx-logs:
    name: paw-nginx-logs
  nginx-cache:
    name: paw-nginx-cache
